<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro Spelling Exam</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
}

body{
    font-family: var(--tg-theme-font-family, 'Segoe UI', Arial, sans-serif);
    background: var(--tg-theme-bg-color, linear-gradient(135deg,#667eea,#764ba2));
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    margin:0;
    padding:10px;
    box-sizing:border-box;
    touch-action: manipulation;
}
.container{
    background: var(--tg-theme-secondary-bg-color, #fff);
    max-width:720px;
    width:100%;
    padding:35px;
    border-radius:20px;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
}
h1{
    text-align:center;
    color: var(--tg-theme-button-color, #667eea);
}
.page{display:none}
.page.active{display:block}

.btn{
    width:100%;
    padding:15px;
    border:none;
    border-radius:10px;
    background: var(--tg-theme-button-color, #667eea);
    color: var(--tg-theme-button-text-color, #fff);
    font-size:18px;
    margin:10px 0;
    cursor:pointer;
    user-select:none;
    -webkit-user-select:none;
    transition: transform 0.1s, opacity 0.1s;
    touch-action: manipulation;
}

.btn:active{
    transform:scale(0.96);
    opacity: 0.85;
}

.btn-secondary{
    background: var(--tg-theme-secondary-bg-color, #f0f0f0);
    color: var(--tg-theme-text-color, #000);
}

input{
    width:100%;
    padding:15px;
    font-size:18px;
    border-radius:10px;
    border:2px solid var(--tg-theme-hint-color, #ddd);
    box-sizing:border-box;
    background: var(--tg-theme-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
}

.center{text-align:center}
.counter{
    font-size:20px;
    color: var(--tg-theme-button-color, #667eea);
    margin-top:10px;
}
.timer{
    font-size:26px;
    font-weight:bold;
    color:#f44336;
    margin:10px 0;
}

.play{
    width:90px;
    height:90px;
    border-radius:50%;
    border:none;
    background:#4CAF50;
    color:#fff;
    font-size:36px;
    cursor:pointer;
    transition: transform 0.1s, opacity 0.1s;
    touch-action: manipulation;
    user-select:none;
    -webkit-user-select:none;
}

.play:active{
    transform:scale(0.92);
    opacity: 0.85;
}

.result{
    padding:12px;
    border-radius:8px;
    margin:8px 0;
    color: var(--tg-theme-text-color, #000);
}
.ok{background:#e8f5e9;border-left:5px solid #4CAF50}
.no{background:#ffebee;border-left:5px solid #f44336}

.modal{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
}
.modal-box{
    background: var(--tg-theme-secondary-bg-color, #fff);
    color: var(--tg-theme-text-color, #000);
    padding:30px;
    border-radius:15px;
    max-width:420px;
    width:90%;
    text-align:center;
}

.info-text{
    color: var(--tg-theme-hint-color, #999);
    font-size:14px;
    margin:10px 0;
}

.share-btn{
    background:#229ED9;
    margin-top:10px;
}

a {
    text-decoration: none;
    display: block;
}

</style>
</head>

<body>
<div class="container">

<!-- HOME -->
<div id="home" class="page active">
<h1>üéØ Pro Spelling Exam</h1>
<p class="info-text center">Train with words and numbers</p>
<button class="btn" data-action="word-mode" type="button">üìù Words</button>
<button class="btn" data-action="number-mode" type="button">üî¢ Numbers</button>
<a href="https://monkeytype.com/" target="_blank">
    <button class="btn btn-secondary" type="button">‚å®Ô∏è Typing Practice ‚ÜóÔ∏è</button>
</a>
</div>

<!-- DIFFICULTY -->
<div id="difficulty" class="page">
<h1>‚öôÔ∏è Choose Difficulty</h1>
<button class="btn" data-action="difficulty-easy">üü¢ Easy</button>
<button class="btn" data-action="difficulty-normal">üü° Normal</button>
<button class="btn" data-action="difficulty-difficult">üî¥ Difficult</button>
</div>

<!-- TEST -->
<div id="test" class="page">
<h1>‚úçÔ∏è Spell Carefully</h1>

<div class="center counter" id="counter"></div>
<div class="center timer" id="timer"></div>

<div class="center" style="margin:20px">
<button class="play" data-action="play">‚ñ∂</button>
<div id="replayInfo" class="info-text"></div>
</div>

<input id="answer" placeholder="Type here..." autocomplete="off">
<button class="btn" data-action="next">Next ‚û°Ô∏è</button>
</div>

<!-- RESULT -->
<div id="result" class="page">
<h1>üìä Your Result</h1>
<div id="score" class="center" style="font-size:32px;font-weight:bold;color:var(--tg-theme-button-color, #667eea);margin:20px 0"></div>
<div id="percentage" class="center info-text"></div>
<div id="list"></div>
<button class="btn share-btn" data-action="share">üì§ Share Result</button>
<button class="btn" data-action="restart">üîÑ Restart</button>
<button class="btn btn-secondary" data-action="home">üè† Home</button>
</div>

</div>

<!-- TIME UP MODAL -->
<div id="timeUpModal" class="modal">
<div class="modal-box">
    <h2 style="color:#f44336">‚è∞ Time is up!</h2>
    <p>Vaqt tugadi. Ushbu savol yakunlandi.</p>
    <button class="btn" data-action="confirm-timeup">OK</button>
</div>
</div>

<script>
// Telegram WebApp initialization
const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

// Set header color
tg.setHeaderColor('secondary_bg_color');

// Get user info
const user = tg.initDataUnsafe?.user;
const userName = user ? (user.first_name || 'User') : 'User';

// Haptic feedback
function haptic(type = 'light') {
    if (tg.HapticFeedback) {
        if (type === 'light') tg.HapticFeedback.impactOccurred('light');
        else if (type === 'medium') tg.HapticFeedback.impactOccurred('medium');
        else if (type === 'heavy') tg.HapticFeedback.impactOccurred('heavy');
        else if (type === 'success') tg.HapticFeedback.notificationOccurred('success');
        else if (type === 'error') tg.HapticFeedback.notificationOccurred('error');
    }
}

const counter = document.getElementById("counter");
const timer = document.getElementById("timer");
const replayInfo = document.getElementById("replayInfo");
const answer = document.getElementById("answer");
const timeUpModal = document.getElementById("timeUpModal");
const score = document.getElementById("score");
const percentage = document.getElementById("percentage");
const list = document.getElementById("list");

const synth = speechSynthesis;
const MAX_REPLAY = 3;

let timerInterval;
let secondsLeft;
let replay;
let index = 0;
let items = [];
let answers = [];
let modalOpen = false;

let selectedMode = "";
let selectedDifficulty = "";
let dynamicTime = 25;

/* WORD LISTS */
const EASY_WORDS = [
"simple","basic","modern","natural","future",
"system","method","design","process","support",
"apple","pear","banana","orange","grape",
"bread","water","coffee","sugar","salt",
"global","local","public","private","normal",
"easy","clear","clean","safe","ready",
"name","fullname","number","email","address",
"phone","login","logout","profile","account",
"board","table","chair","window","door",
"bridge","road","street","house","room",
"book","pen","paper","note","school",
"class","teacher","student","lesson","exam",
"work","job","office","company","team",
"manager","worker","client","service","task",
"play","game","sport","music","movie",
"video","photo","camera","sound","screen",
"time","day","night","week","month",
"year","today","tomorrow","yesterday","now",
"open","close","start","stop","save",
"load","send","receive","click","press",
"happy","sad","good","bad","big",
"small","fast","slow","new","old"
];

const NORMAL_WORDS = [
"optimization","implementation","authentication",
"infrastructure","reconciliation","transparency",
"globalization","inevitable","substantial","contemporary",
"collaboration","administration","interpretation","prioritization",
"consideration","qualification","responsibility","significance",
"environmental","technological","development","organization",
"communication","representation","recommendation","identification",
"establishment","transformation","documentation","investigation",
"configuration","specialization","characteristic","classification",
"participation","regulation","distribution","coordination",
"negotiation","presentation","standardization","recognition",
"integration","innovation","evaluation","adaptation",
"maintenance","production","submission","collection",
"preparation","observation","prediction","competition",
"association","assumption","interaction","conclusion"
];

const DIFFICULT_WORDS = [
"entrepreneurship","sustainability","accountability",
"unprecedented","meticulous","phenomenon",
"multifaceted","sophisticated","visualization","vulnerability",
"inconsequential","disproportionate","counterproductive","interdisciplinary",
"misinterpretation","institutionalization","overcompensation","methodological",
"philosophical","psychological",
"electromagnetic","thermodynamics","biotechnology","neuroscience",
"cryptocurrency","decentralization","interoperability","quantification",
"approximation","differentiation",
"heterogeneous","homogeneous","idiosyncratic","paradigmatic",
"heuristic","axiomatic","empirical","theoretical","speculative","deterministic",
"irreversibility","incompatibility","inaccessibility","unpredictability",
"interchangeability","reproducibility","generalization","contextualization",
"conceptualization","operationalization",
"bureaucratization","commercialization","democratization","industrialization",
"privatization","monopolization","digitalization","globalization","urbanization",
"modernization",
"dissemination","proliferation","consolidation","diversification",
"prioritization","rationalization","standardization","synchronization",
"optimization","restructuring",
"misconception","presupposition","juxtaposition","contradiction",
"ambiguity","paradox","fallibility","subjectivity","objectivity","relativity",
"circumstantial","substantiation","corroboration","justification",
"extrapolation","interpretability","verifiability","plausibility",
"credibility","reliability",
"anthropological","sociological","epistemological","ontological",
"metaphysical","existential","phenomenological","dialectical",
"hermeneutical","teleological"
];

/* UTILS */
function shuffle(a){ return a.sort(()=>Math.random()-0.5); }
    
function randomNumbers(n){
    let s=new Set();
    while(s.size<n){
        let len=Math.floor(Math.random()*5)+4;
        let num="";
        for(let i=0;i<len;i++) num+=Math.floor(Math.random()*10);
        s.add(num);
    }
    return [...s];
}

function show(id){
    document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
    document.getElementById(id).classList.add("active");
}

/* FLOW */
function openDifficulty(mode){
    haptic('light');
    selectedMode = mode;
    show("difficulty");
}

function chooseDifficulty(level){
    haptic('medium');
    selectedDifficulty = level;

    if(selectedMode === "word"){
        items =
            level==="easy" ? shuffle([...EASY_WORDS]) :
            level==="normal" ? shuffle([...NORMAL_WORDS]) :
            shuffle([...DIFFICULT_WORDS]);
        items = items.slice(0,10);
        dynamicTime = 25;
    }

    if(selectedMode === "number"){
        let count = level==="easy"?3:level==="normal"?6:9;
        items = randomNumbers(count);
        dynamicTime = level==="easy"?30:level==="normal"?20:12;
    }

    index = 0;
    answers = [];
    show("test");
    loadWord();
}

function loadWord(){
    synth.cancel();
    modalOpen = false;
    replay = MAX_REPLAY;
    secondsLeft = dynamicTime;

    counter.innerText = `${index+1} / ${items.length}`;
    replayInfo.innerText = `üîä Replay left: ${replay}`;
    answer.value = "";
    
    updateTimerUI();
    startTimer();
    setTimeout(()=>{
        play();
        answer.focus();
    },500);
}

function startTimer(){
    clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
        secondsLeft--;
        updateTimerUI();
        if(secondsLeft<=0 && !modalOpen){
            clearInterval(timerInterval);
            handleTimeUp();
        }
    },1000);
}

function updateTimerUI(){
    timer.innerText = `‚è± ${secondsLeft}s`;
}

function spell(text){
    synth.cancel();
    [...text].forEach((c,i)=>{
        let u=new SpeechSynthesisUtterance(c);
        u.lang="en-US";
        u.rate=0.75;
        setTimeout(()=>synth.speak(u),i*450);
    });
}

function play(){
    if(replay<=0 || modalOpen) return;
    haptic('light');
    replay--;
    replayInfo.innerText = `üîä Replay left: ${replay}`;
    spell(items[index].toString());
}

function handleTimeUp(){
    modalOpen = true;
    synth.cancel();
    haptic('error');
    let u=new SpeechSynthesisUtterance("Time is up");
    u.lang="en-US";
    synth.speak(u);
    timeUpModal.style.display="flex";
}

function confirmTimeUp(){
    haptic('light');
    timeUpModal.style.display="none";
    next();
}

function manualNext(){
    haptic('light');
    clearInterval(timerInterval);
    next();
}

function next(){
    answers.push(answer.value.trim());
    index++;
    if(index<items.length) loadWord();
    else showResult();
}

function showResult(){
    let correct=0, html="";
    items.forEach((w,i)=>{
        let ok=w.toLowerCase()===(answers[i]||"").toLowerCase();
        if(ok) correct++;
        html+=`<div class="result ${ok?"ok":"no"}">
        <b>${w}</b><br>Your answer: ${answers[i]||"(no answer)"}
        </div>`;
    });
    
    const percent = Math.round((correct/items.length)*100);
    score.innerText=`${correct} / ${items.length}`;
    percentage.innerText=`${percent}% to'g'ri`;
    list.innerHTML=html;
    
    if(percent >= 70) {
        haptic('success');
    } else {
        haptic('error');
    }
    
    show("result");
}

function shareResult(){
    haptic('medium');
    const correct = answers.filter((a,i)=>items[i].toLowerCase()===a.toLowerCase()).length;
    const percent = Math.round((correct/items.length)*100);
    
    const modeText = selectedMode === 'word' ? 'Words' : 'Numbers';
    const diffText = selectedDifficulty.charAt(0).toUpperCase() + selectedDifficulty.slice(1);
    
    const text = `üéØ Pro Spelling Exam
    
Mode: ${modeText}
Difficulty: ${diffText}
Score: ${correct}/${items.length} (${percent}%)

Try it yourself! üëá`;
    
    const url = 'https://t.me/share/url?url=' + encodeURIComponent('https://t.me/YourBotUsername') + '&text=' + encodeURIComponent(text);
    tg.openTelegramLink(url);
}

// Universal click handler for all buttons
function handleClick(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const target = e.target.closest('[data-action]');
    if (!target) return;
    
    const action = target.dataset.action;
    
    switch(action) {
        case 'word-mode':
            openDifficulty('word');
            break;
        case 'number-mode':
            openDifficulty('number');
            break;
        case 'difficulty-easy':
            chooseDifficulty('easy');
            break;
        case 'difficulty-normal':
            chooseDifficulty('normal');
            break;
        case 'difficulty-difficult':
            chooseDifficulty('difficult');
            break;
        case 'play':
            play();
            break;
        case 'next':
            manualNext();
            break;
        case 'confirm-timeup':
            confirmTimeUp();
            break;
        case 'restart':
            haptic('medium');
            location.reload();
            break;
        case 'home':
            haptic('light');
            show('home');
            break;
        case 'share':
            shareResult();
            break;
    }
}

// Add event listener to document for event delegation
document.addEventListener('touchend', handleClick, false);
document.addEventListener('click', handleClick, false);

// Enter key support
answer.addEventListener("keydown",e=>{
    if(e.key==="Enter") manualNext();
});

// Back button handling
tg.BackButton.onClick(()=>{
    haptic('light');
    const activePage = document.querySelector('.page.active');
    if(activePage.id === 'difficulty') show('home');
    else if(activePage.id === 'test') show('difficulty');
    else if(activePage.id === 'result') show('home');
    else tg.close();
});

// Show/hide back button based on current page
function updateBackButton(){
    const activePage = document.querySelector('.page.active');
    if(activePage.id !== 'home') {
        tg.BackButton.show();
    } else {
        tg.BackButton.hide();
    }
}

const observer = new MutationObserver(updateBackButton);
document.querySelectorAll('.page').forEach(page => {
    observer.observe(page, { attributes: true, attributeFilter: ['class'] });
});

updateBackButton();
</script>
</body>
</html>
